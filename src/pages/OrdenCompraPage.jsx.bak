import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { Helmet } from 'react-helmet';
import { motion } from 'framer-motion';
import { supabase } from '@/lib/customSupabaseClient';
import { useToast } from '@/components/ui/use-toast';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Calendar } from '@/components/ui/calendar';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Save, X, Loader2, Plus, Trash2, Bot, FileDown } from 'lucide-react';
import { addDays } from 'date-fns';
import { formatInTimeZone, getCurrentDateInTimeZone, formatDateForSupabase } from '@/lib/dateUtils';
import { useNavigate } from 'react-router-dom';
import ProductSearchModal from '@/components/ventas/ProductSearchModal';
import { generateOrderPDF } from '@/components/common/PDFGenerator';

const OrdenCompraPage = () => {
  const { toast } = useToast();
  const navigate = useNavigate();
  const [proveedores, setProveedores] = useState([]);
  const [selectedProveedor, setSelectedProveedor] = useState(null);

  const [orden, setOrden] = useState({
    numero: '',
    fecha_orden: getCurrentDateInTimeZone(),
    fecha_vencimiento: addDays(getCurrentDateInTimeZone(), 30),
    notas: '',
    aplicar_itbis: true,
    itbis_incluido: false,
    // UI-only (solo guardar si existe columna en DB)
    direccion_entrega: '',
  });

  const [detalles, setDetalles] = useState([]);
  const [isSaving, setIsSaving] = useState(false);
  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);

  const fetchProveedores = useCallback(async () => {
    const { data, error } = await supabase
      .from('proveedores')
      .select('*')
      .eq('activo', true);
    if (error) {
      toast({ variant: 'destructive', title: 'Error', description: 'No se pudieron cargar los proveedores.' });
    } else {
      setProveedores(data);
    }
  }, [toast]);

  useEffect(() => {
    fetchProveedores();
  }, [fetchProveedores]);

  const handleProveedorChange = (id) => {
    const prov = proveedores.find((p) => p.id === id);
    setSelectedProveedor(prov || null);
  };

  // Añadir manual: cantidad y sugerida = 1
  const addProductToOrder = (product) => {
    if (detalles.find((d) => d.producto_id === product.id)) {
      toast({ title: 'Producto ya agregado', description: 'Este producto ya se encuentra en la orden.' });
      return;
    }
    const itbisPct = product.itbis_pct || 0;
    const precio = product.costo || product.precio || 0;

    const newDetalle = {
      id: Date.now(),
      producto_id: product.id,
      codigo: product.codigo,
      descripcion: product.descripcion,
      cantidad: 1,
      sugerida: 1,
      unidad: 'UND',
      precio,
      descuento_pct: 0,
      itbis_pct: itbisPct,
      importe: 0,
    };

    setDetalles((prev) => calculateAllImportes([...prev, newDetalle]));
  };

  const calculateImporte = (detalle) => {
    const cantidad = parseFloat(detalle.cantidad) || 0;
    const precio = parseFloat(detalle.precio) || 0;
    const descuento = parseFloat(detalle.descuento_pct) || 0;
    const itbis_pct = parseFloat(detalle.itbis_pct) || 0;

    const subtotal = cantidad * precio;
    const montoDescuento = subtotal * (descuento / 100);
    const baseItbis = subtotal - montoDescuento;
    const montoItbis = orden.aplicar_itbis ? baseItbis * (itbis_pct / 100) : 0;

    return baseItbis + montoItbis;
  };

  const calculateAllImportes = (list) => list.map((d) => ({ ...d, importe: calculateImporte(d) }));

  // Si se edita cantidad, sincronizo sugerida (manejamos un solo número visible)
  const handleUpdateDetalle = (id, field, value) => {
    setDetalles((prev) => {
      const updated = prev.map((d) => {
        if (d.id !== id) return d;
        const patch = { ...d, [field]: value };
        if (field === 'cantidad') patch.sugerida = value;
        return patch;
      });
      return calculateAllImportes(updated);
    });
  };

  const removeDetalle = (id) => {
    setDetalles((prev) => prev.filter((d) => d.id !== id));
  };

  useEffect(() => {
    setDetalles((prev) => calculateAllImportes(prev));
  }, [orden.aplicar_itbis]);

  const totals = useMemo(() => {
    let total_exento = 0;
    let total_gravado = 0;
    let descuento_total = 0;
    let itbis_total = 0;

    detalles.forEach((d) => {
      const cantidad = parseFloat(d.cantidad) || 0;
      const precio = parseFloat(d.precio) || 0;
      const descPct = (parseFloat(d.descuento_pct) || 0) / 100;
      const itbisPct = (parseFloat(d.itbis_pct) || 0) / 100;

      const subtotal = cantidad * precio;
      const descMonto = subtotal * descPct;
      const base = subtotal - descMonto;

      descuento_total += descMonto;

      if (itbisPct > 0 && orden.aplicar_itbis) {
        total_gravado += base;
        itbis_total += base * itbisPct;
      } else {
        total_exento += base;
      }
    });

    const total_orden = total_gravado + total_exento + itbis_total;
    return { total_exento, total_gravado, descuento_total, itbis_total, total_orden };
  }, [detalles, orden.aplicar_itbis]);

  const handleOrdenAutomatica = async () => {
    if (!selectedProveedor) {
      toast({
        variant: 'destructive',
        title: 'Seleccione un suplidor',
        description: 'Debe seleccionar un suplidor para generar una orden automática.',
      });
      return;
    }
    setIsGenerating(true);
    const { data, error } = await supabase.rpc('get_productos_para_orden_automatica', {
      p_suplidor_id: selectedProveedor.id,
    });
    setIsGenerating(false);

    if (error) {
      toast({ variant: 'destructive', title: 'Error', description: 'No se pudieron obtener los productos bajo stock.' });
      return;
    }
    if (!data || data.length === 0) {
      toast({ title: 'Sin productos', description: 'No hay productos bajo el stock mínimo para este suplidor.' });
      return;
    }

    const newDetalles = data.map((p) => {
      const diff = (p.max_stock || p.min_stock || 0) - (p.existencia || 0);
      const sugerida = diff > 0 ? Math.ceil(diff) : 1;
      return {
        id: Date.now() + Math.random(),
        producto_id: p.id,
        codigo: p.codigo,
        descripcion: p.descripcion,
        cantidad: sugerida,
        sugerida,
        unidad: 'UND',
        precio: p.precio || 0,
        descuento_pct: 0,
        itbis_pct: p.itbis_pct || 0,
        importe: 0,
      };
    });

    setDetalles(calculateAllImportes(newDetalles));
    toast({ title: 'Orden Automática Generada', description: `${data.length} productos bajo stock fueron añadidos.` });
  };

  const handleSave = async () => {
    if (!selectedProveedor || detalles.length === 0) {
      toast({
        variant: 'destructive',
        title: 'Datos incompletos',
        description: 'Debe seleccionar un suplidor y añadir al menos un producto.',
      });
      return;
    }
    setIsSaving(true);

    const ordenData = {
      numero: orden.numero,
      fecha_orden: formatDateForSupabase(orden.fecha_orden),
      fecha_vencimiento: formatDateForSupabase(orden.fecha_vencimiento),
      notas: orden.notas,
      aplicar_itbis: orden.aplicar_itbis,
      itbis_incluido: orden.itbis_incluido,
      suplidor_id: selectedProveedor.id,
      ...totals,
      // direccion_entrega: orden.direccion_entrega, // descomentar si existe en DB
    };

    const { data: savedOrden, error: ordenError } = await supabase
      .from('ordenes_compra')
      .insert(ordenData)
      .select()
      .single();

    if (ordenError) {
      toast({ variant: 'destructive', title: 'Error al guardar la orden', description: ordenError.message });
      setIsSaving(false);
      return;
    }

    const detallesData = detalles.map((d) => ({
      orden_compra_id: savedOrden.id,
      producto_id: d.producto_id,
      codigo: d.codigo,
      descripcion: d.descripcion,
      cantidad: d.cantidad,
      unidad: d.unidad,
      precio: d.precio,
      descuento_pct: d.descuento_pct,
      itbis_pct: d.itbis_pct,
      importe: d.importe,
    }));

    const { error: detallesError } = await supabase.from('ordenes_compra_detalle').insert(detallesData);

    if (detallesError) {
      toast({ variant: 'destructive', title: 'Error al guardar detalles', description: detallesError.message });
    } else {
      toast({ title: 'Éxito', description: 'Orden de compra guardada correctamente.' });

      generateOrderPDF(savedOrden, selectedProveedor, detalles);

      // Reset
      setSelectedProveedor(null);
      setOrden({
        numero: '',
        fecha_orden: getCurrentDateInTimeZone(),
        fecha_vencimiento: addDays(getCurrentDateInTimeZone(), 30),
        notas: '',
        aplicar_itbis: true,
        itbis_incluido: false,
        direccion_entrega: '',
      });
      setDetalles([]);
    }

    setIsSaving(false);
  };

  const handleKeyDown = useCallback(
    (e) => {
      if (e.key === 'F10') { e.preventDefault(); handleSave(); }
      if (e.key === 'Escape') { e.preventDefault(); navigate(-1); }
    },
    [navigate]
  );

  useEffect(() => {
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [handleKeyDown]);

  return (
    <>
      <Helmet>
        <title>Orden de Compra - Repuestos Morla</title>
      </Helmet>

      <ProductSearchModal
        isOpen={isSearchModalOpen}
        onClose={() => setIsSearchModalOpen(false)}
        onSelectProduct={addProductToOrder}
      />

      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="p-4 bg-gray-100 min-h-full text-[13px] leading-tight"
      >
        <div className="bg-white p-4 rounded-sm shadow-sm border border-gray-200">
          {/* Título */}
          <div className="text-center text-morla-blue font-bold mb-2 tracking-wide">
            <h1 className="text-lg">ORDEN DE COMPRA</h1>
          </div>

          {/* 3 paneles igual altura */}
          <div className="grid grid-cols-1 md:grid-cols-[34%_36%_30%] items-stretch gap-3 mb-3">
            {/* Datos de Suplidor */}
            <div className="h-full flex flex-col p-3 border border-gray-300 rounded-sm bg-white space-y-2 relative [&_label]:text-[13px] [&_input]:h-8 [&_input]:text-[13px] [&_textarea]:text-[13px]">
              <Label className="absolute -top-2.5 left-3 bg-white px-1 text-gray-600 font-medium">Datos de Suplidor</Label>

              <div className="grid grid-cols-2 gap-2">
                <div>
                  <Label className="text-gray-600">Suplidor</Label>
                  <Select onValueChange={handleProveedorChange} value={selectedProveedor?.id || ''}>
                    <SelectTrigger className="h-8 text-[13px]">
                      <SelectValue placeholder="Seleccione un suplidor..." />
                    </SelectTrigger>
                    <SelectContent>
                      {proveedores.map((p) => (
                        <SelectItem key={p.id} value={p.id}>{p.nombre}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label className="text-gray-600">RNC</Label>
                  <Input value={selectedProveedor?.rnc || ''} readOnly />
                </div>
              </div>

              <div><Label className="text-gray-600">Nombre</Label><Input value={selectedProveedor?.nombre || ''} readOnly /></div>
              <div><Label className="text-gray-600">Dirección</Label><Input value={selectedProveedor?.direccion || ''} readOnly /></div>
              <div><Label className="text-gray-600">Teléfonos</Label><Input value={selectedProveedor?.telefono || ''} readOnly /></div>
            </div>

            {/* Dirección de Entrega */}
            <div className="h-full flex flex-col p-3 border border-gray-300 rounded-sm bg-white space-y-2 relative [&_label]:text-[13px]">
              <Label className="absolute -top-2.5 left-3 bg-white px-1 text-gray-600 font-medium">Dirección de Entrega</Label>
              <Textarea
                rows={5}
                className="w-full flex-1 resize-none text-[13px] min-h-[120px]"
                placeholder="(Opcional) Dirección donde se recibirá la mercancía"
                value={orden.direccion_entrega}
                onChange={(e) => setOrden({ ...orden, direccion_entrega: e.target.value })}
              />
            </div>

            {/* Detalles de la Orden */}
            <div className="h-full flex flex-col p-3 border border-gray-300 rounded-sm bg-white space-y-2 relative [&_label]:text-[13px] [&_input]:h-8 [&_input]:text-[13px] [&_button]:h-8">
              <Label className="absolute -top-2.5 left-3 bg-white px-1 text-gray-600 font-medium">Detalles de la Orden</Label>
              <div><Label className="text-gray-600">NÚMERO</Label><Input value={orden.numero} onChange={(e) => setOrden({ ...orden, numero: e.target.value })} /></div>
              <div>
                <Label className="text-gray-600">FECHA</Label>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button variant="outline" className="w-full justify-start font-normal h-8 text-[13px]">
                      <span className="lucide lucide-calendar mr-2 h-4 w-4" />
                      {formatInTimeZone(orden.fecha_orden, 'dd/MM/yyyy')}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0">
                    <Calendar mode="single" selected={orden.fecha_orden} onSelect={(d) => setOrden({ ...orden, fecha_orden: d })} />
                  </PopoverContent>
                </Popover>
              </div>
              <div>
                <Label className="text-gray-600">VENCE</Label>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button variant="outline" className="w-full justify-start font-normal h-8 text-[13px]">
                      <span className="lucide lucide-calendar mr-2 h-4 w-4" />
                      {formatInTimeZone(orden.fecha_vencimiento, 'dd/MM/yyyy')}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0">
                    <Calendar mode="single" selected={orden.fecha_vencimiento} onSelect={(d) => setOrden({ ...orden, fecha_vencimiento: d })} />
                  </PopoverContent>
                </Popover>
              </div>
            </div>
          </div>

          {/* TABLA */}
          <div className="border border-gray-300 rounded-sm overflow-hidden">
            <Table>
              <TableHeader className="bg-gray-100">
                <TableRow className="[&_th]:py-2 [&_th]:text-gray-700">
                  <TableHead className="w-[120px]">CÓDIGO</TableHead>
                  <TableHead>DESCRIPCIÓN</TableHead>
                  {/* ancho mayor para que el número no quede debajo del spinner */}
                  <TableHead className="w-[90px] text-center">CANT.</TableHead>
                  <TableHead className="w-[80px] text-center">UNIDAD</TableHead>
                  <TableHead className="w-[110px] text-right">PRECIO</TableHead>
                  <TableHead className="w-[80px] text-right">DESC.%</TableHead>
                  <TableHead className="w-[80px] text-right">ITBIS</TableHead>
                  <TableHead className="w-[120px] text-right">IMPORTE</TableHead>
                  <TableHead className="w-[40px]" />
                </TableRow>
              </TableHeader>

              <TableBody className="[&_td]:py-1.5">
                {detalles.map((d) => (
                  <TableRow key={d.id}>
                    <TableCell>{d.codigo}</TableCell>
                    <TableCell>{d.descripcion}</TableCell>

                    {/* CANT.: input centrado y con padding a la derecha para el spinner */}
                    <TableCell>
                      <Input
                        type="number"
                        inputMode="numeric"
                        step="1"
                        min="0"
                        value={d.cantidad ?? 0}
                        onChange={(e) =>
                          handleUpdateDetalle(
                            d.id,
                            'cantidad',
                            e.target.value === '' ? '' : e.target.value
                          )
                        }
                        className="h-8 w-[90px] text-center pr-10"
                      />
                    </TableCell>

                    <TableCell>
                      <Select value={d.unidad} onValueChange={(v) => handleUpdateDetalle(d.id, 'unidad', v)}>
                        <SelectTrigger className="h-8">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="UND">UND</SelectItem>
                          <SelectItem value="CAJA">CAJA</SelectItem>
                          <SelectItem value="PAR">PAR</SelectItem>
                        </SelectContent>
                      </Select>
                    </TableCell>

                    <TableCell>
                      <Input
                        type="number"
                        value={d.precio}
                        onChange={(e) => handleUpdateDetalle(d.id, 'precio', e.target.value)}
                        className="h-8 text-right"
                      />
                    </TableCell>

                    <TableCell>
                      <Input
                        type="number"
                        value={d.descuento_pct}
                        onChange={(e) => handleUpdateDetalle(d.id, 'descuento_pct', e.target.value)}
                        className="h-8 text-right"
                      />
                    </TableCell>

                    <TableCell className="text-right">{(parseFloat(d.itbis_pct) || 0).toFixed(2)}%</TableCell>
                    <TableCell className="text-right font-semibold">{(parseFloat(d.importe) || 0).toFixed(2)}</TableCell>

                    <TableCell>
                      <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => removeDetalle(d.id)}>
                        <Trash2 className="h-4 w-4 text-red-500" />
                      </Button>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>

            <div className="p-2 bg-gray-50 border-t border-gray-300">
              <Button size="sm" onClick={() => setIsSearchModalOpen(true)}>
                <Plus className="mr-2 h-4 w-4" /> Añadir Producto
              </Button>
            </div>
          </div>

          {/* Notas + Totales */}
          <div className="grid grid-cols-1 md:grid-cols-[70%_30%] gap-3 mt-3">
            <div className="space-y-2">
              <Label>Notas / Comentario</Label>
              <Textarea
                value={orden.notas}
                onChange={(e) => setOrden({ ...orden, notas: e.target.value })}
                rows={5}
                className="w-full"
              />
              <div className="flex flex-wrap gap-2">
                <Button onClick={handleOrdenAutomatica} disabled={!selectedProveedor || isGenerating}>
                  {isGenerating ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Bot className="mr-2 h-4 w-4" />}
                  ORDEN AUTOMÁTICA
                </Button>
                <Button
                  variant="secondary"
                  onClick={() => generateOrderPDF({ ...orden, ...totals }, selectedProveedor, detalles)}
                  disabled={detalles.length === 0 || !selectedProveedor}
                >
                  <FileDown className="mr-2 h-4 w-4" /> Generar PDF
                </Button>
              </div>
            </div>

            <div className="p-3 border border-gray-300 rounded-sm space-y-2 bg-white">
              <div className="flex items-center space-x-2">
                <Checkbox id="aplicar-itbis" checked={orden.aplicar_itbis} onCheckedChange={(c) => setOrden({ ...orden, aplicar_itbis: !!c })} />
                <Label htmlFor="aplicar-itbis">Aplicar ITBIS</Label>
              </div>
              <div className="flex items-center space-x-2">
                <Checkbox id="itbis-incluido" checked={orden.itbis_incluido} onCheckedChange={(c) => setOrden({ ...orden, itbis_incluido: !!c })} />
                <Label htmlFor="itbis-incluido">ITBIS incluido?</Label>
              </div>

              <div className="border-t pt-2 mt-1 space-y-1 text-[13px]">
                <div className="flex justify-between"><span>Total Exento:</span><span className="font-mono">{totals.total_exento.toFixed(2)}</span></div>
                <div className="flex justify-between"><span>Total Gravado:</span><span className="font-mono">{totals.total_gravado.toFixed(2)}</span></div>
                <div className="flex justify-between"><span>Descuento:</span><span className="font-mono text-red-600">{totals.descuento_total.toFixed(2)}</span></div>
                <div className="flex justify-between"><span>ITBIS:</span><span className="font-mono">{totals.itbis_total.toFixed(2)}</span></div>
                <div className="flex justify-between text-base font-bold border-t mt-1 pt-1"><span>TOTAL:</span><span className="font-mono text-red-600">{totals.total_orden.toFixed(2)}</span></div>
              </div>

              <div className="pt-1">
                <Label>Imprimir en</Label>
                <Select defaultValue="normal">
                  <SelectTrigger className="h-8"><SelectValue /></SelectTrigger>
                  <SelectContent><SelectItem value="normal">8.5 Pulgadas (Papel Normal)</SelectItem></SelectContent>
                </Select>
              </div>
            </div>
          </div>

          {/* Botonera inferior */}
          <div className="mt-4 flex justify-end gap-3">
            <Button variant="outline" onClick={() => navigate(-1)} disabled={isSaving}><X className="mr-2 h-4 w-4" /> ESC - Retornar</Button>
            <Button className="bg-morla-blue hover:bg-morla-blue/90" onClick={handleSave} disabled={isSaving}>
              {isSaving ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Save className="mr-2 h-4 w-4" />} F10 - Continuar
            </Button>
          </div>
        </div>
      </motion.div>
    </>
  );
};

export default OrdenCompraPage;
